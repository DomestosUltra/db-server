-- =====================================================
-- ЛАБОРАТОРНАЯ РАБОТА №4
-- Многотабличные запросы и подзапросы в PostgreSQL
-- Вариант 10: Туристическое агентство
-- =====================================================

-- Выполненные запросы согласно заданию:

-- 1. Найти всех руководителей туров, которые обслуживают только автобусные туры 
--    и выполнившие заказы на туры со стоимостью больше средней за последние 3 месяца

-- 2. Найти все туры за последний месяц со стоимостью больше средней стоимости 
--    железнодорожных туров за последние 2 недели

-- 3. Найти все авиатуры в Турцию и Египет для семейного отдыха дороже 
--    средней стоимости туров-шопингов

-- =====================================================
-- ОПИСАНИЕ РЕШЕНИЯ:
-- =====================================================

-- Создана расширенная схема БД с добавлением:
-- - Поле country в таблицу cities (для запроса 3)
-- - Поле tour_category в таблицу tours (для запросов 3)
-- - Ограничения на типы туров и категории

-- Добавлены данные для демонстрации всех условий:
-- - Города в разных странах (включая Турцию и Египет)
-- - Туры разных типов и категорий
-- - Заказы с разными временными рамками
-- - Руководители с разной специализацией

-- =====================================================
-- ОСНОВНЫЕ ТЕХНИКИ, ИСПОЛЬЗОВАННЫЕ В ЗАПРОСАХ:
-- =====================================================

-- 1. CTE (Common Table Expressions) для подзапросов
-- 2. JOIN различных типов для связи таблиц
-- 3. NOT EXISTS для проверки отсутствия записей
-- 4. Агрегатные функции (AVG, COUNT, STRING_AGG)
-- 5. Условия по временным интервалам (INTERVAL)
-- 6. Группировка и сортировка результатов

-- =====================================================
-- КЛЮЧЕВЫЕ ЗАПРОСЫ:
-- =====================================================

-- ЗАПРОС 1: Использует CTE и NOT EXISTS для поиска руководителей,
-- обслуживающих только автобусные туры, с проверкой стоимости заказов

-- ЗАПРОС 2: Сравнивает стоимость туров за месяц со средней стоимостью
-- железнодорожных туров за 2 недели через подзапрос

-- ЗАПРОС 3: Фильтрует авиатуры по стране и категории, сравнивая
-- с средней стоимостью туров-шопингов

-- =====================================================
-- РЕЗУЛЬТАТЫ ВЫПОЛНЕНИЯ:
-- =====================================================

-- При правильном выполнении должны быть получены:
-- 1. Руководители (Иванов, Сидоров, Попов, Федоров) с высокими заказами
-- 2. Туры за сентябрь 2025 дороже средней стоимости ж/д туров
-- 3. Семейные авиатуры в Турцию/Египет дороже шопинг-туров

-- Все запросы демонстрируют использование многотабличных соединений
-- и сложных подзапросов для решения аналитических задач